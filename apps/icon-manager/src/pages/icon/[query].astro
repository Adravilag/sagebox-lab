---
import Layout from '../../layouts/Layout.astro';
import IconDetailModal from '../../components/IconDetailModal.astro';
import { readIcons } from '../../lib/icons';
import { getLocale, createT, type Locale } from '../../lib/i18n';

// Get query from URL params
const { query } = Astro.params;
const searchQuery = decodeURIComponent(query || '');

// Get locale
const locale = getLocale(Astro.request) as Locale;
const t = createT(locale);

// Read existing icons to check which ones are already imported
const existingIcons = await readIcons();
const existingNames = new Set(existingIcons.map(icon => icon.name));
---

<Layout title={`Search: ${searchQuery} - Icon Manager`}>
  <div class="search-page">
    <header class="search-header">
      <div class="search-header-top">
        <a href="/" class="back-btn" title="Back to Icon Manager">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M19 12H5M12 19l-7-7 7-7"/>
          </svg>
        </a>
        <div class="search-box">
          <svg class="search-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
          <input 
            type="text" 
            id="search-input" 
            placeholder="Search icons..."
            value={searchQuery}
            autofocus
          />
          <kbd class="search-kbd">/</kbd>
        </div>
        <a href="/" class="home-btn" title="Icon Manager">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <polyline points="9 22 9 12 15 12 15 22"/>
          </svg>
        </a>
      </div>
    </header>

    <main class="search-main">
      <div class="search-results-header" id="search-results-header">
        <div class="results-info">
          <span class="results-query" id="results-query">{searchQuery}</span>
          <span class="results-count" id="results-count"></span>
        </div>
        <div class="results-actions">
          <button class="filter-btn active" data-filter="all">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
              <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
            </svg>
            All
          </button>
          <button class="filter-btn" data-filter="outline">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10"/>
            </svg>
            Outline
          </button>
          <button class="filter-btn" data-filter="solid">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor">
              <circle cx="12" cy="12" r="10"/>
            </svg>
            Solid
          </button>
        </div>
      </div>

      <div class="icon-grid" id="icon-grid"></div>
      
      <div class="loading-state" id="loading-state">
        <div class="loading-spinner">
          <svg width="32" height="32" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2" fill="none" opacity="0.2"/>
            <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round">
              <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="0.8s" repeatCount="indefinite"/>
            </path>
          </svg>
        </div>
        <p>Searching icons...</p>
      </div>
      
      <div class="empty-state" id="empty-state" style="display: none;">
        <div class="empty-icon">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
            <circle cx="11" cy="11" r="8"/>
            <path d="M21 21l-4.35-4.35"/>
          </svg>
        </div>
        <h3>No icons found</h3>
        <p>Try a different search term or browse popular sets</p>
        <a href="/icon" class="empty-action">Browse suggestions</a>
      </div>
    </main>

    <div class="selection-bar" id="selection-bar">
      <div class="selection-left">
        <div class="selection-check">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <polyline points="20 6 9 17 4 12"/>
          </svg>
        </div>
        <div class="selection-info">
          <span class="selection-count" id="selection-count">0</span>
          <span class="selection-label">icons selected</span>
        </div>
      </div>
      <div class="selection-actions">
        <button class="sel-btn sel-btn-ghost" id="clear-selection">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
          Clear
        </button>
        <button class="sel-btn sel-btn-primary" id="add-selected">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12h14"/>
          </svg>
          Add to Library
        </button>
      </div>
    </div>

    <div class="toast" id="toast"></div>

    <!-- Icon Detail Modal (Reusable Component) -->
    <IconDetailModal locale={locale} />
  </div>
</Layout>

<script define:vars={{ searchQuery, existingNames: [...existingNames] }}>
  window.__SEARCH_QUERY__ = searchQuery;
  window.__EXISTING_ICONS__ = new Set(existingNames);
</script>

<script>
  const searchInput = document.getElementById('search-input') as HTMLInputElement;
  const loadingState = document.getElementById('loading-state')!;
  const iconGrid = document.getElementById('icon-grid')!;
  const emptyState = document.getElementById('empty-state')!;
  const selectionBar = document.getElementById('selection-bar')!;
  const selectionCount = document.getElementById('selection-count')!;
  const clearSelectionBtn = document.getElementById('clear-selection')!;
  const addSelectedBtn = document.getElementById('add-selected') as HTMLButtonElement;
  const toast = document.getElementById('toast')!;
  const resultsQuery = document.getElementById('results-query')!;
  const resultsCount = document.getElementById('results-count')!;
  const resultsHeader = document.getElementById('search-results-header')!;

  const existingIcons = (window as any).__EXISTING_ICONS__ as Set<string>;
  const initialQuery = (window as any).__SEARCH_QUERY__ as string;
  
  let selectedIcons = new Map<string, string>(); // name -> svg content
  let searchTimeout: ReturnType<typeof setTimeout>;
  let allIconCards: HTMLElement[] = [];

  // Toast notification
  function showToast(message: string, type: 'success' | 'error' = 'success') {
    toast.textContent = message;
    toast.className = `toast ${type} visible`;
    setTimeout(() => toast.classList.remove('visible'), 3000);
  }

  // Update selection bar
  function updateSelectionBar() {
    selectionCount.textContent = selectedIcons.size.toString();
    selectionBar.classList.toggle('visible', selectedIcons.size > 0);
  }

  // Navigate to search
  function navigateToSearch(query: string) {
    if (query.trim()) {
      window.history.pushState({}, '', `/icon/${encodeURIComponent(query.trim())}`);
      performSearch(query.trim());
    }
  }

  // Search icons
  async function performSearch(query: string) {
    if (!query || query.length < 2) {
      loadingState.style.display = 'none';
      iconGrid.innerHTML = '';
      emptyState.style.display = 'none';
      resultsHeader.style.display = 'none';
      return;
    }

    loadingState.style.display = 'flex';
    iconGrid.innerHTML = '';
    emptyState.style.display = 'none';
    resultsHeader.style.display = 'none';
    resultsQuery.textContent = query;

    try {
      const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=100`);
      const data = await res.json();

      loadingState.style.display = 'none';

      if (!res.ok || data.error) {
        showToast(data.error || 'Search failed', 'error');
        return;
      }

      const icons = data.icons || [];
      
      if (icons.length === 0) {
        emptyState.style.display = 'flex';
        return;
      }

      resultsCount.textContent = `${data.total} results`;
      resultsHeader.style.display = 'flex';

      // Fetch SVG content for all icons
      await renderIcons(icons);

    } catch (error) {
      console.error('Search error:', error);
      loadingState.style.display = 'none';
      showToast('Search failed. Please try again.', 'error');
    }
  }

  // Render icons in grid
  async function renderIcons(iconNames: string[]) {
    iconGrid.innerHTML = '';
    allIconCards = [];

    // Group by prefix for batch fetching
    const byPrefix: Record<string, string[]> = {};
    for (const icon of iconNames) {
      const [prefix, name] = icon.split(':');
      if (!byPrefix[prefix]) byPrefix[prefix] = [];
      byPrefix[prefix].push(name);
    }

    // Fetch SVGs in batches
    for (const [prefix, names] of Object.entries(byPrefix)) {
      try {
        const url = `https://api.iconify.design/${prefix}.json?icons=${names.join(',')}`;
        const res = await fetch(url);
        const data = await res.json();

        for (const name of names) {
          const iconData = data.icons?.[name];
          if (!iconData) continue;

          const fullName = `${prefix}:${name}`;
          const width = iconData.width || data.width || 24;
          const height = iconData.height || data.height || 24;
          const body = iconData.body;

          const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 ${width} ${height}" fill="currentColor">${body}</svg>`;
          const isExisting = existingIcons.has(fullName);
          const isSelected = selectedIcons.has(fullName);
          
          // Detect icon style
          const isOutline = body.includes('stroke=') || body.includes('fill="none"') || 
                          prefix.includes('outline') || prefix.includes('line');
          const isSolid = !isOutline;

          const card = document.createElement('div');
          card.className = `icon-card${isExisting ? ' existing' : ''}${isSelected ? ' selected' : ''}`;
          card.dataset.name = fullName;
          card.dataset.style = isOutline ? 'outline' : 'solid';
          card.innerHTML = `
            <div class="icon-checkbox">
              <input type="checkbox" ${isSelected ? 'checked' : ''} ${isExisting ? 'disabled' : ''} />
            </div>
            <button class="icon-detail-btn" title="View details">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
            </button>
            ${isExisting ? '<div class="icon-badge">âœ“</div>' : ''}
            <div class="icon-preview">${svg}</div>
            <div class="icon-info">
              <span class="icon-name" title="${fullName}">${name}</span>
              <span class="icon-prefix">${prefix}</span>
            </div>
          `;

          // Store SVG for later use
          card.dataset.svg = svg;

          // Detail button handler
          const detailBtn = card.querySelector('.icon-detail-btn');
          detailBtn?.addEventListener('click', (e) => {
            e.stopPropagation();
            openIconDetailModal(fullName, svg, prefix);
          });

          // Click handler for selection
          card.addEventListener('click', (e) => {
            const target = e.target as HTMLElement;
            // Skip if clicking detail button
            if (target.closest('.icon-detail-btn')) return;
            if (isExisting) return;
            
            const checkbox = card.querySelector('input[type="checkbox"]') as HTMLInputElement;
            if (e.target !== checkbox) {
              checkbox.checked = !checkbox.checked;
            }

            if (checkbox.checked) {
              selectedIcons.set(fullName, svg);
              card.classList.add('selected');
            } else {
              selectedIcons.delete(fullName);
              card.classList.remove('selected');
            }
            updateSelectionBar();
          });

          iconGrid.appendChild(card);
          allIconCards.push(card);
        }
      } catch (error) {
        console.error(`Error fetching icons for ${prefix}:`, error);
      }
    }
  }

  // Filter buttons
  document.querySelectorAll('.filter-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      
      const filter = (btn as HTMLElement).dataset.filter;
      
      allIconCards.forEach(card => {
        if (filter === 'all') {
          card.style.display = '';
        } else {
          card.style.display = card.dataset.style === filter ? '' : 'none';
        }
      });
    });
  });

  // Search input handlers
  searchInput?.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      navigateToSearch(searchInput.value);
    }
  });

  searchInput?.addEventListener('input', () => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      if (searchInput.value.length >= 2) {
        navigateToSearch(searchInput.value);
      }
    }, 500);
  });

  // Keyboard shortcut for search
  document.addEventListener('keydown', (e) => {
    if (e.key === '/' && document.activeElement !== searchInput) {
      e.preventDefault();
      searchInput?.focus();
      searchInput?.select();
    }
  });

  // Clear selection
  clearSelectionBtn?.addEventListener('click', () => {
    selectedIcons.clear();
    iconGrid.querySelectorAll('.icon-card.selected').forEach(card => {
      card.classList.remove('selected');
      const checkbox = card.querySelector('input[type="checkbox"]') as HTMLInputElement;
      if (checkbox) checkbox.checked = false;
    });
    updateSelectionBar();
  });

  // Add selected icons
  addSelectedBtn?.addEventListener('click', async () => {
    if (selectedIcons.size === 0) return;

    addSelectedBtn.disabled = true;
    addSelectedBtn.innerHTML = `
      <svg class="spinner" width="16" height="16" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="3" fill="none" opacity="0.25"/>
        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="3" fill="none" stroke-linecap="round">
          <animateTransform attributeName="transform" type="rotate" from="0 12 12" to="360 12 12" dur="1s" repeatCount="indefinite"/>
        </path>
      </svg>
      Adding...
    `;

    let added = 0;
    let failed = 0;

    for (const [name, svg] of selectedIcons) {
      try {
        const res = await fetch('/api/icons/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, content: svg })
        });

        if (res.ok) {
          added++;
          existingIcons.add(name);
          
          // Update card UI
          const card = iconGrid.querySelector(`.icon-card[data-name="${name}"]`);
          if (card) {
            card.classList.remove('selected');
            card.classList.add('existing');
            const badge = document.createElement('div');
            badge.className = 'icon-badge existing';
            badge.textContent = 'Imported';
            card.appendChild(badge);
            const checkbox = card.querySelector('input[type="checkbox"]') as HTMLInputElement;
            if (checkbox) {
              checkbox.checked = false;
              checkbox.disabled = true;
            }
          }
        } else {
          failed++;
        }
      } catch {
        failed++;
      }
    }

    selectedIcons.clear();
    updateSelectionBar();

    addSelectedBtn.disabled = false;
    addSelectedBtn.innerHTML = `
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 5v14M5 12h14"/>
      </svg>
      Add to Library
    `;

    if (added > 0) {
      showToast(`${added} icon${added > 1 ? 's' : ''} added to library`, 'success');
    }
    if (failed > 0) {
      showToast(`${failed} icon${failed > 1 ? 's' : ''} failed to add`, 'error');
    }
  });

  // Handle browser navigation
  window.addEventListener('popstate', () => {
    const path = window.location.pathname;
    const match = path.match(/^\/icon\/(.+)$/);
    if (match) {
      const query = decodeURIComponent(match[1]);
      searchInput.value = query;
      performSearch(query);
    }
  });

  // Open icon detail modal using the shared component
  function openIconDetailModal(name: string, svg: string, prefix: string) {
    // The IconDetailModal component exposes openIconDetail globally
    // Check if this icon is already in the library
    const isExisting = existingIcons.has(name);
    
    if (typeof (window as any).openIconDetail === 'function') {
      (window as any).openIconDetail({
        name: name,
        content: svg,
        category: prefix,
        isExisting: isExisting
      });
    }
  }

  // Initial search if query provided
  if (initialQuery) {
    performSearch(initialQuery);
  }
</script>

<style>
  .search-page {
    min-height: 100vh;
    background: #09090b;
    color: #f4f4f5;
    font-family: 'Inter', system-ui, -apple-system, sans-serif;
  }

  /* Header */
  .search-header {
    position: sticky;
    top: 0;
    z-index: 100;
    background: rgba(9, 9, 11, 0.85);
    backdrop-filter: blur(16px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.06);
    padding: 0.75rem 1rem;
  }

  .search-header-top {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .back-btn, .home-btn {
    width: 38px;
    height: 38px;
    border-radius: 10px;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    color: #71717a;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    transition: all 150ms ease;
    flex-shrink: 0;
  }

  .back-btn:hover, .home-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #f4f4f5;
    border-color: rgba(255, 255, 255, 0.15);
  }

  .search-box {
    flex: 1;
    position: relative;
    display: flex;
    align-items: center;
  }

  .search-icon {
    position: absolute;
    left: 0.875rem;
    color: #52525b;
    pointer-events: none;
  }

  #search-input {
    width: 100%;
    padding: 0.625rem 3rem 0.625rem 2.75rem;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 10px;
    color: #f4f4f5;
    font-size: 0.9375rem;
    font-family: inherit;
    transition: all 150ms ease;
  }

  #search-input:focus {
    outline: none;
    background: rgba(255, 255, 255, 0.08);
    border-color: #6366f1;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
  }

  #search-input::placeholder {
    color: #52525b;
  }

  .search-kbd {
    position: absolute;
    right: 0.75rem;
    font-size: 0.6875rem;
    font-family: inherit;
    color: #52525b;
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid rgba(255, 255, 255, 0.1);
    padding: 0.125rem 0.375rem;
    border-radius: 4px;
  }

  /* Main content */
  .search-main {
    padding: 1.25rem;
    padding-bottom: 120px;
  }

  /* Results header */
  .search-results-header {
    display: none;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
    gap: 0.75rem;
  }

  .results-info {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .results-query {
    font-size: 1.125rem;
    font-weight: 600;
    color: #f4f4f5;
  }

  .results-count {
    font-size: 0.8125rem;
    color: #71717a;
    background: rgba(255, 255, 255, 0.05);
    padding: 0.25rem 0.625rem;
    border-radius: 6px;
  }

  .results-actions {
    display: flex;
    gap: 0.375rem;
  }

  .filter-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.375rem;
    padding: 0.4375rem 0.75rem;
    background: transparent;
    border: 1px solid rgba(255, 255, 255, 0.08);
    border-radius: 8px;
    color: #71717a;
    font-size: 0.8125rem;
    font-family: inherit;
    cursor: pointer;
    transition: all 150ms ease;
  }

  .filter-btn:hover {
    background: rgba(255, 255, 255, 0.05);
    color: #a1a1aa;
  }

  .filter-btn.active {
    background: rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
    color: #818cf8;
  }

  /* Loading state */
  .loading-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    color: #71717a;
    gap: 1rem;
  }

  .loading-spinner {
    color: #6366f1;
  }

  .loading-state p {
    font-size: 0.875rem;
  }

  /* Icon grid */
  .icon-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(110px, 1fr));
    gap: 0.625rem;
  }

  .icon-card {
    position: relative;
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid rgba(255, 255, 255, 0.06);
    border-radius: 12px;
    padding: 0.875rem 0.625rem 0.625rem;
    cursor: pointer;
    transition: all 150ms ease;
    text-align: center;
  }

  .icon-card:hover:not(.existing) {
    background: rgba(255, 255, 255, 0.05);
    border-color: rgba(255, 255, 255, 0.12);
    transform: translateY(-2px);
  }

  .icon-card.selected {
    background: rgba(99, 102, 241, 0.1);
    border-color: rgba(99, 102, 241, 0.4);
  }

  .icon-card.selected:hover {
    background: rgba(99, 102, 241, 0.15);
  }

  .icon-card.existing {
    opacity: 0.5;
    cursor: default;
  }

  .icon-checkbox {
    position: absolute;
    top: 0.5rem;
    left: 0.5rem;
    opacity: 0;
    transition: opacity 150ms ease;
  }

  .icon-card:hover .icon-checkbox,
  .icon-card.selected .icon-checkbox {
    opacity: 1;
  }

  .icon-checkbox input {
    width: 14px;
    height: 14px;
    cursor: pointer;
    accent-color: #6366f1;
  }

  .icon-checkbox input:disabled {
    cursor: default;
  }

  .icon-badge {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 18px;
    height: 18px;
    background: rgba(34, 197, 94, 0.2);
    color: #22c55e;
    border-radius: 50%;
    font-size: 0.625rem;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .icon-preview {
    width: 100%;
    aspect-ratio: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 0.625rem;
    color: #f4f4f5;
  }

  .icon-preview svg {
    width: 28px;
    height: 28px;
  }

  .icon-card:hover:not(.existing) .icon-preview svg {
    transform: scale(1.1);
    transition: transform 150ms ease;
  }

  .icon-info {
    min-height: 32px;
  }

  .icon-name {
    display: block;
    font-size: 0.6875rem;
    font-weight: 500;
    color: #e4e4e7;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    margin-bottom: 0.125rem;
  }

  .icon-prefix {
    display: block;
    font-size: 0.5625rem;
    color: #52525b;
    text-transform: uppercase;
    letter-spacing: 0.05em;
  }

  /* Empty state */
  .empty-state {
    display: none;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    text-align: center;
  }

  .empty-icon {
    width: 80px;
    height: 80px;
    background: rgba(255, 255, 255, 0.03);
    border-radius: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-bottom: 1.5rem;
    color: #3f3f46;
  }

  .empty-state h3 {
    font-size: 1rem;
    font-weight: 600;
    color: #a1a1aa;
    margin: 0 0 0.5rem 0;
  }

  .empty-state p {
    font-size: 0.875rem;
    color: #52525b;
    margin: 0 0 1.5rem 0;
  }

  .empty-action {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.625rem 1.25rem;
    background: rgba(99, 102, 241, 0.1);
    border: 1px solid rgba(99, 102, 241, 0.2);
    border-radius: 8px;
    color: #818cf8;
    font-size: 0.875rem;
    font-weight: 500;
    text-decoration: none;
    transition: all 150ms ease;
  }

  .empty-action:hover {
    background: rgba(99, 102, 241, 0.15);
    border-color: rgba(99, 102, 241, 0.3);
  }

  /* Selection bar */
  .selection-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(24, 24, 27, 0.95);
    backdrop-filter: blur(12px);
    border-top: 1px solid rgba(255, 255, 255, 0.08);
    padding: 0.875rem 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    transform: translateY(100%);
    transition: transform 200ms cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 100;
  }

  .selection-bar.visible {
    transform: translateY(0);
  }

  .selection-left {
    display: flex;
    align-items: center;
    gap: 0.75rem;
  }

  .selection-check {
    width: 32px;
    height: 32px;
    background: rgba(99, 102, 241, 0.15);
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: #818cf8;
  }

  .selection-info {
    display: flex;
    align-items: baseline;
    gap: 0.375rem;
  }

  .selection-count {
    font-size: 1.125rem;
    font-weight: 600;
    color: #f4f4f5;
  }

  .selection-label {
    font-size: 0.8125rem;
    color: #71717a;
  }

  .selection-actions {
    display: flex;
    gap: 0.5rem;
  }

  .sel-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    font-size: 0.8125rem;
    font-weight: 500;
    font-family: inherit;
    border: none;
    cursor: pointer;
    transition: all 150ms ease;
  }

  .sel-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .sel-btn-ghost {
    background: transparent;
    color: #71717a;
    border: 1px solid rgba(255, 255, 255, 0.1);
  }

  .sel-btn-ghost:hover:not(:disabled) {
    background: rgba(255, 255, 255, 0.05);
    color: #a1a1aa;
  }

  .sel-btn-primary {
    background: #6366f1;
    color: white;
  }

  .sel-btn-primary:hover:not(:disabled) {
    background: #4f46e5;
  }

  /* Toast */
  .toast {
    position: fixed;
    bottom: 100px;
    left: 50%;
    transform: translateX(-50%) translateY(20px);
    background: #18181b;
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 10px;
    padding: 0.75rem 1.25rem;
    font-size: 0.875rem;
    color: #f4f4f5;
    opacity: 0;
    pointer-events: none;
    transition: all 200ms ease;
    z-index: 200;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
  }

  .toast.visible {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }

  .toast.success {
    border-color: rgba(34, 197, 94, 0.3);
    background: rgba(34, 197, 94, 0.1);
    color: #4ade80;
  }

  .toast.error {
    border-color: rgba(239, 68, 68, 0.3);
    background: rgba(239, 68, 68, 0.1);
    color: #f87171;
  }

  /* Spinner animation */
  .spinner {
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  /* Responsive */
  @media (max-width: 640px) {
    .search-kbd {
      display: none;
    }

    .icon-grid {
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 0.5rem;
    }

    .icon-card {
      padding: 0.75rem 0.5rem 0.5rem;
    }

    .icon-preview svg {
      width: 24px;
      height: 24px;
    }

    .filter-btn span {
      display: none;
    }

    .selection-bar {
      padding: 0.75rem 1rem;
    }

    .sel-btn {
      padding: 0.5rem 0.75rem;
    }

    .sel-btn span {
      display: none;
    }
  }

  @media (min-width: 1200px) {
    .icon-grid {
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    }
  }

  /* Detail Button */
  .icon-detail-btn {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    width: 24px;
    height: 24px;
    background: rgba(255, 255, 255, 0.08);
    border: 1px solid rgba(255, 255, 255, 0.1);
    border-radius: 6px;
    color: #71717a;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    opacity: 0;
    transition: all 150ms ease;
    z-index: 5;
  }

  .icon-card:hover .icon-detail-btn {
    opacity: 1;
  }

  .icon-detail-btn:hover {
    background: rgba(99, 102, 241, 0.2);
    border-color: rgba(99, 102, 241, 0.4);
    color: #818cf8;
  }

  .icon-card.existing .icon-detail-btn {
    right: 1.75rem;
  }
</style>

